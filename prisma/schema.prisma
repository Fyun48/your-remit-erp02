generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 組織架構 ====================

model Group {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companies Company[]

  @@map("groups")
}

model Company {
  id        String   @id @default(cuid())
  groupId   String
  name      String
  code      String   @unique
  taxId     String? // 統一編號
  address   String?
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group       Group                @relation(fields: [groupId], references: [id])
  departments Department[]
  positions   Position[]
  employees   EmployeeAssignment[]
  workShifts  WorkShift[]
  shiftAssignments ShiftAssignment[]
  attendanceRecords AttendanceRecord[]
  leaveTypes  LeaveType[]
  approvalFlows ApprovalFlow[]

  @@map("companies")
}

model Department {
  id        String   @id @default(cuid())
  companyId String
  parentId  String?
  name      String
  code      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company              @relation(fields: [companyId], references: [id])
  parent    Department?          @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children  Department[]         @relation("DepartmentHierarchy")
  employees EmployeeAssignment[]

  @@unique([companyId, code])
  @@map("departments")
}

model Position {
  id        String   @id @default(cuid())
  companyId String
  name      String
  code      String
  level     Int      @default(0) // 職級，用於審核流程
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company              @relation(fields: [companyId], references: [id])
  employees EmployeeAssignment[]

  @@unique([companyId, code])
  @@map("positions")
}

// ==================== 員工 ====================

model Employee {
  id                 String    @id @default(cuid())
  employeeNo         String    @unique // 員工編號
  email              String    @unique
  personalEmail      String? // 個人 Email
  passwordHash       String
  name               String
  idNumber           String? // 身分證字號
  gender             Gender?
  birthDate          DateTime?
  phone              String?
  residentialAddress String? // 居住地地址
  householdAddress   String? // 戶籍地址
  emergencyContact   String?
  emergencyPhone     String?
  hireDate           DateTime
  resignDate         DateTime?
  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  assignments EmployeeAssignment[]
  permissions EmployeePermission[]
  sessions    Session[]
  accounts    Account[]

  @@map("employees")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

model EmployeeAssignment {
  id           String           @id @default(cuid())
  employeeId   String
  companyId    String
  departmentId String
  positionId   String
  roleId       String?
  supervisorId String? // 直屬主管
  isPrimary    Boolean          @default(false) // 是否為主要任職公司
  startDate    DateTime
  endDate      DateTime?
  status       AssignmentStatus @default(ACTIVE)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  employee     Employee             @relation(fields: [employeeId], references: [id])
  company      Company              @relation(fields: [companyId], references: [id])
  department   Department           @relation(fields: [departmentId], references: [id])
  position     Position             @relation(fields: [positionId], references: [id])
  role         Role?                @relation(fields: [roleId], references: [id])
  supervisor   EmployeeAssignment?  @relation("Supervision", fields: [supervisorId], references: [id])
  subordinates EmployeeAssignment[] @relation("Supervision")

  @@unique([employeeId, companyId])
  @@map("employee_assignments")
}

enum AssignmentStatus {
  ACTIVE // 在職
  ON_LEAVE // 留停
  RESIGNED // 離職
}

// ==================== 權限 ====================

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false) // 系統角色不可刪除
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permissions RolePermission[]
  employees   EmployeeAssignment[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "attendance.clock", "leave.apply"
  name        String
  module      String // e.g., "attendance", "leave", "expense"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles     RolePermission[]
  employees EmployeePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model EmployeePermission {
  id           String    @id @default(cuid())
  employeeId   String
  companyId    String
  permissionId String
  grantType    GrantType
  grantedById  String? // 誰授權的
  grantedAt    DateTime  @default(now())
  expiresAt    DateTime? // 權限過期時間（可選）

  employee   Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([employeeId, companyId, permissionId])
  @@map("employee_permissions")
}

enum GrantType {
  GRANT // 授予
  REVOKE // 移除
}

// ==================== NextAuth.js ====================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("employee_id")
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user Employee @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String   @map("employee_id")
  expires      DateTime

  user Employee @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==================== 出勤管理 ====================

enum ShiftType {
  FIXED    // 固定班
  FLEXIBLE // 彈性班
}

enum ClockMethod {
  WEB    // 網頁打卡
  APP    // APP打卡
  GPS    // GPS定位打卡
  IP     // IP限制打卡
  FACE   // 人臉辨識
  MANUAL // 人工補登
}

enum AttendanceStatus {
  PENDING     // 待確認
  NORMAL      // 正常
  LATE        // 遲到
  EARLY_LEAVE // 早退
  ABSENT      // 曠職
  LEAVE       // 請假
  EXEMPT      // 免打卡
}

model WorkShift {
  id                    String    @id @default(cuid())
  companyId             String
  name                  String    // 班別名稱
  code                  String    // 班別代碼
  shiftType             ShiftType @default(FIXED)

  // 固定班時間
  workStartTime         String?   // 上班時間 "HH:mm"
  workEndTime           String?   // 下班時間 "HH:mm"

  // 彈性班設定
  coreStartTime         String?   // 核心時間開始 "HH:mm"
  coreEndTime           String?   // 核心時間結束 "HH:mm"
  flexStartRange        String?   // 彈性上班範圍 "HH:mm-HH:mm"
  flexEndRange          String?   // 彈性下班範圍 "HH:mm-HH:mm"
  requiredHours         Float?    // 每日應工作時數

  // 容許設定
  lateGraceMinutes      Int       @default(0)  // 遲到寬限分鐘
  earlyLeaveGraceMinutes Int      @default(0)  // 早退寬限分鐘
  overtimeThreshold     Int       @default(30) // 加班起算分鐘數

  // 工作日設定
  workDays              String    @default("1,2,3,4,5") // 工作日（週一=1）

  isActive              Boolean   @default(true)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  company               Company         @relation(fields: [companyId], references: [id])
  breaks                ShiftBreak[]
  assignments           ShiftAssignment[]

  @@unique([companyId, code])
  @@map("work_shifts")
}

model ShiftBreak {
  id         String   @id @default(cuid())
  shiftId    String
  name       String   // 休息名稱（如：午休、下午茶）
  startTime  String   // 開始時間 "HH:mm"
  endTime    String   // 結束時間 "HH:mm"
  isPaid     Boolean  @default(false) // 是否為有薪休息
  isRequired Boolean  @default(true)  // 是否為必要休息
  sortOrder  Int      @default(0)

  shift      WorkShift @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@map("shift_breaks")
}

model ShiftAssignment {
  id            String    @id @default(cuid())
  employeeId    String
  companyId     String
  shiftId       String
  effectiveDate DateTime  @db.Date // 生效日期
  endDate       DateTime? @db.Date // 結束日期
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  company       Company   @relation(fields: [companyId], references: [id])
  shift         WorkShift @relation(fields: [shiftId], references: [id])

  @@unique([employeeId, companyId, effectiveDate])
  @@map("shift_assignments")
}

model AttendanceRecord {
  id               String           @id @default(cuid())
  employeeId       String
  companyId        String
  date             DateTime         @db.Date // 出勤日期

  // 上班打卡
  clockInTime      DateTime?
  clockInMethod    ClockMethod?
  clockInLocation  String?          // GPS座標或地點描述
  clockInIp        String?

  // 下班打卡
  clockOutTime     DateTime?
  clockOutMethod   ClockMethod?
  clockOutLocation String?
  clockOutIp       String?

  // 出勤狀態
  status           AttendanceStatus @default(PENDING)
  lateMinutes      Int              @default(0) // 遲到分鐘數
  earlyLeaveMinutes Int             @default(0) // 早退分鐘數
  overtimeMinutes  Int              @default(0) // 加班分鐘數
  workHours        Float?           // 實際工作時數

  // 補登資訊
  isAmended        Boolean          @default(false) // 是否為補登
  amendReason      String?          // 補登原因
  approvedById     String?          // 審核人

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  company          Company          @relation(fields: [companyId], references: [id])

  @@unique([employeeId, companyId, date])
  @@map("attendance_records")
}

// ==================== 請假管理 ====================

model LeaveType {
  id        String       @id @default(cuid())
  companyId String?      // NULL = 集團共用法定假別
  code      String       // ANNUAL, SICK, PERSONAL, etc.
  name      String
  category  LeaveCategory @default(STATUTORY)

  // 請假規則
  requiresReason       Boolean @default(true)
  requiresAttachment   Boolean @default(false)
  attachmentAfterDays  Int     @default(0)
  minUnit              LeaveUnit @default(HOUR)

  // 額度規則
  quotaType          QuotaType @default(FIXED)
  annualQuotaDays    Float     @default(0)
  canCarryOver       Boolean   @default(false)
  carryOverLimitDays Float     @default(0)
  canCashOut         Boolean   @default(false)
  cashOutRate        Float     @default(1.0)

  // 使用限制
  advanceDaysRequired Int      @default(0)
  maxConsecutiveDays  Int      @default(0)
  genderRestriction   Gender?
  applicableAfterDays Int      @default(0)

  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company  Company?       @relation(fields: [companyId], references: [id])
  requests LeaveRequest[]
  balances LeaveBalance[]

  @@unique([companyId, code])
  @@map("leave_types")
}

enum LeaveCategory {
  STATUTORY
  COMPANY
}

enum LeaveUnit {
  HOUR
  HALF_DAY
  DAY
}

enum QuotaType {
  FIXED
  SENIORITY
  UNLIMITED
}

model LeaveRequest {
  id          String   @id @default(cuid())
  requestNo   String   @unique
  employeeId  String
  companyId   String
  leaveTypeId String

  startDate   DateTime
  startPeriod LeavePeriod @default(FULL_DAY)
  endDate     DateTime
  endPeriod   LeavePeriod @default(FULL_DAY)
  totalHours  Float

  reason      String?
  attachments String?
  proxyEmployeeId String?

  status      LeaveStatus @default(DRAFT)
  submittedAt DateTime?
  processedAt DateTime?

  currentApproverId String?
  approvedById      String?
  rejectedById      String?
  approvalComment   String?

  actualEndDate    DateTime?
  cancelledHours   Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@index([employeeId, companyId])
  @@index([status])
  @@map("leave_requests")
}

enum LeavePeriod {
  FULL_DAY
  AM
  PM
}

enum LeaveStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model LeaveBalance {
  id          String @id @default(cuid())
  employeeId  String
  companyId   String
  leaveTypeId String
  year        Int

  entitledHours Float @default(0)
  carriedHours  Float @default(0)
  adjustedHours Float @default(0)

  usedHours    Float @default(0)
  pendingHours Float @default(0)

  cashedOutHours  Float @default(0)
  cashOutAmount   Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@unique([employeeId, companyId, leaveTypeId, year])
  @@map("leave_balances")
}

// ==================== 審核流程引擎 ====================

// 審核流程模板
model ApprovalFlow {
  id          String   @id @default(cuid())
  companyId   String?  // NULL = 集團通用
  code        String   // LEAVE, EXPENSE, OVERTIME, etc.
  name        String
  description String?
  module      String   // leave, expense, overtime, etc.

  // 條件觸發（JSON 格式）
  conditions  String?

  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company   Company?       @relation(fields: [companyId], references: [id])
  steps     ApprovalStep[]
  instances ApprovalInstance[]

  @@unique([companyId, code])
  @@map("approval_flows")
}

// 審核關卡
model ApprovalStep {
  id         String   @id @default(cuid())
  flowId     String
  stepOrder  Int
  name       String

  approverType   ApproverType
  approverValue  String?

  approvalMode   ApprovalMode @default(ANY)

  canSkip        Boolean  @default(false)
  skipCondition  String?

  ccType         ApproverType?
  ccValue        String?

  timeoutHours   Int      @default(0)
  timeoutAction  TimeoutAction @default(NONE)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  flow           ApprovalFlow       @relation(fields: [flowId], references: [id], onDelete: Cascade)
  stepInstances  ApprovalStepInstance[]

  @@unique([flowId, stepOrder])
  @@map("approval_steps")
}

enum ApproverType {
  SUPERVISOR
  DEPARTMENT_HEAD
  POSITION_LEVEL
  SPECIFIC_POSITION
  SPECIFIC_EMPLOYEE
  ROLE
}

enum ApprovalMode {
  ANY
  ALL
  MAJORITY
}

enum TimeoutAction {
  NONE
  REMIND
  ESCALATE
  AUTO_APPROVE
  AUTO_REJECT
}

// 審核流程實例
model ApprovalInstance {
  id           String   @id @default(cuid())
  flowId       String

  module       String
  referenceId  String

  applicantId  String
  companyId    String

  status       ApprovalInstanceStatus @default(IN_PROGRESS)
  currentStep  Int      @default(1)

  startedAt    DateTime @default(now())
  completedAt  DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  flow         ApprovalFlow          @relation(fields: [flowId], references: [id])
  stepInstances ApprovalStepInstance[]

  @@unique([module, referenceId])
  @@index([applicantId, companyId])
  @@index([status])
  @@map("approval_instances")
}

enum ApprovalInstanceStatus {
  IN_PROGRESS
  APPROVED
  REJECTED
  CANCELLED
}

// 審核關卡實例
model ApprovalStepInstance {
  id           String   @id @default(cuid())
  instanceId   String
  stepId       String
  stepOrder    Int

  assignedTo   String   // JSON array of employeeIds

  status       StepInstanceStatus @default(PENDING)

  assignedAt   DateTime @default(now())
  dueAt        DateTime?
  completedAt  DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  instance     ApprovalInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  step         ApprovalStep     @relation(fields: [stepId], references: [id])
  actions      ApprovalAction[]

  @@unique([instanceId, stepOrder])
  @@map("approval_step_instances")
}

enum StepInstanceStatus {
  PENDING
  APPROVED
  REJECTED
  SKIPPED
}

// 審核動作記錄
model ApprovalAction {
  id              String   @id @default(cuid())
  stepInstanceId  String

  actorId         String

  action          ActionType
  comment         String?

  actedAt         DateTime @default(now())

  stepInstance    ApprovalStepInstance @relation(fields: [stepInstanceId], references: [id], onDelete: Cascade)

  @@map("approval_actions")
}

enum ActionType {
  APPROVE
  REJECT
  RETURN
  DELEGATE
  CC
}

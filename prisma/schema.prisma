generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Neon: 用於 migrations（非 pooler）
}

// ==================== 稽核日誌 ====================

model AuditLog {
  id         String   @id @default(cuid())
  entityType String // Employee, Department, Voucher, SealRequest...
  entityId   String // 資料主鍵
  action     String // CREATE, UPDATE, DELETE
  path       String? // 修改欄位路徑 (如: employee.name)
  oldValue   Json? // 修改前的值
  newValue   Json? // 修改後的值
  operatorId String
  operator   Employee @relation("AuditOperator", fields: [operatorId], references: [id])
  companyId  String?
  company    Company? @relation(fields: [companyId], references: [id])
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([operatorId])
  @@index([companyId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Audit 設定（控制哪些操作需要被記錄）
model AuditSetting {
  id          String   @id @default(cuid())
  entityType  String // Employee, Department, Voucher...
  action      String // CREATE, UPDATE, DELETE
  isEnabled   Boolean  @default(true) // 是否啟用記錄
  updatedById String? // 最後更新者
  updatedAt   DateTime @updatedAt

  @@unique([entityType, action])
  @@map("audit_settings")
}

// ==================== 集團級權限 ====================

model GroupPermission {
  id          String              @id @default(cuid())
  employeeId  String
  employee    Employee            @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  permission  GroupPermissionType
  grantedById String // 授權人 ID
  grantedBy   Employee            @relation("GroupPermissionGranter", fields: [grantedById], references: [id])
  grantedAt   DateTime            @default(now())
  expiresAt   DateTime? // 權限到期時間
  isActive    Boolean             @default(true)
  note        String?

  @@unique([employeeId, permission])
  @@index([employeeId])
  @@map("group_permissions")
}

enum GroupPermissionType {
  SUPER_ADMIN // 超級管理員（最高權限）
  GROUP_ADMIN // 集團管理員
  CROSS_COMPANY_VIEW // 跨公司檢視
  CROSS_COMPANY_EDIT // 跨公司編輯
  AUDIT_LOG_VIEW // 稽核日誌檢視
  COMPANY_MANAGEMENT // 公司管理 (創建/停用)
  DELETE_CHANGE_LOG // 刪除異動紀錄
}

// ==================== 組織架構 ====================

model Group {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companies           Company[]
  orgCharts           OrgChart[]
  workflowDefinitions WorkflowDefinition[]

  @@map("groups")
}

model Company {
  id        String   @id @default(cuid())
  groupId   String
  name      String
  code      String   @unique
  taxId     String? // 統一編號
  address   String?
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 特休計算制度設定
  annualLeaveMethod AnnualLeaveMethod @default(ANNIVERSARY)

  group             Group                @relation(fields: [groupId], references: [id])
  departments       Department[]
  positions         Position[]
  employees         EmployeeAssignment[]
  workShifts        WorkShift[]
  shiftAssignments  ShiftAssignment[]
  attendanceRecords AttendanceRecord[]
  leaveTypes        LeaveType[]
  approvalFlows     ApprovalFlow[]
  expenseCategories ExpenseCategory[]

  // 財務會計關聯
  accountCharts     AccountChart[]
  accountingPeriods AccountingPeriod[]
  customers         Customer[]
  vendors           Vendor[]
  vouchers          Voucher[]
  receivables       AccountReceivable[]
  payables          AccountPayable[]

  // 稽核日誌
  auditLogs AuditLog[]

  // 用印申請
  sealRequests SealRequest[]

  // 名片申請
  businessCardRequests BusinessCardRequest[]

  // 文具管理
  stationeryItems    StationeryItem[]
  stationeryRequests StationeryRequest[]

  // 組織圖
  orgCharts OrgChart[] @relation("CompanyOrgCharts")

  // 工作流程
  workflowDefinitions WorkflowDefinition[] @relation("CompanyWorkflows")
  workflowInstances   WorkflowInstance[]

  // 專案管理
  projects         Project[]
  projectTemplates ProjectTemplate[]

  // 專案 KPI
  projectKpiSetting   ProjectKpiSetting?
  projectKpiSummaries ProjectKpiSummary[]

  // 薪資
  payrollSetting   PayrollSetting?
  employeeSalaries EmployeeSalary[]
  payrollPeriods   PayrollPeriod[]

  // 新版流程管理
  flowTemplates  FlowTemplate[]
  flowExecutions FlowExecution[]
  delegations    Delegation[]

  @@map("companies")
}

model Department {
  id        String   @id @default(cuid())
  companyId String
  parentId  String?
  name      String
  code      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company              @relation(fields: [companyId], references: [id])
  parent    Department?          @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children  Department[]         @relation("DepartmentHierarchy")
  employees EmployeeAssignment[]

  // 財務會計關聯
  voucherLines VoucherLine[]

  // 專案管理
  projects Project[]

  // 專案 KPI
  projectKpiSummaries ProjectKpiSummary[]

  @@unique([companyId, code])
  @@map("departments")
}

model Position {
  id        String   @id @default(cuid())
  companyId String
  name      String
  code      String
  level     Int      @default(0) // 職級，用於審核流程
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company              @relation(fields: [companyId], references: [id])
  employees EmployeeAssignment[]

  // 新版流程管理
  flowSteps FlowStep[]

  @@unique([companyId, code])
  @@map("positions")
}

// ==================== 員工 ====================

model Employee {
  id                 String    @id @default(cuid())
  employeeNo         String    @unique // 員工編號
  email              String    @unique
  personalEmail      String? // 個人 Email
  passwordHash       String
  name               String
  avatarUrl          String? // 員工頭像 URL
  idNumber           String? // 身分證字號
  gender             Gender?
  birthDate          DateTime?
  phone              String?
  officePhone        String? // 公司電話
  extension          String? // 分機號碼
  residentialAddress String? // 居住地地址
  householdAddress   String? // 戶籍地址
  emergencyContact   String?
  emergencyPhone     String?
  hireDate           DateTime
  resignDate         DateTime?
  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  assignments EmployeeAssignment[]
  permissions EmployeePermission[]
  sessions    Session[]
  accounts    Account[]
  preference  UserPreference?

  // 財務會計關聯
  vouchersCreated  Voucher[] @relation("VoucherCreator")
  vouchersApproved Voucher[] @relation("VoucherApprover")
  vouchersPosted   Voucher[] @relation("VoucherPoster")

  // 稽核與集團權限
  auditLogs               AuditLog[]        @relation("AuditOperator")
  groupPermissions        GroupPermission[]
  groupPermissionsGranted GroupPermission[] @relation("GroupPermissionGranter")

  // 用印申請
  sealRequestsApplied   SealRequest[] @relation("SealApplicant")
  sealRequestsProcessed SealRequest[] @relation("SealProcessor")

  // 名片申請
  businessCardRequestsApplied  BusinessCardRequest[] @relation("CardApplicant")
  businessCardRequestsApproved BusinessCardRequest[] @relation("CardApprover")

  // 文具申請
  stationeryRequestsApplied  StationeryRequest[] @relation("StationeryApplicant")
  stationeryRequestsApproved StationeryRequest[] @relation("StationeryApprover")
  stationeryRequestsIssued   StationeryRequest[] @relation("StationeryIssuer")

  // QR Code 登入
  qrLoginTokens QrLoginToken[]

  // 系統通知
  notifications Notification[] @relation("UserNotifications")

  // 工作流程
  workflowDefinitions        WorkflowDefinition[]       @relation("EmployeeWorkflows")
  workflowDefinitionsCreated WorkflowDefinition[]       @relation("WorkflowCreator")
  workflowInstances          WorkflowInstance[]
  approvalRecordsAsApprover  WorkflowApprovalRecord[]   @relation("WorkflowApprover")
  approvalRecordsAsSigner    WorkflowApprovalRecord[]   @relation("WorkflowActualSigner")
  delegatesAsPrincipal       WorkflowApprovalDelegate[] @relation("DelegatePrincipal")
  delegatesAsDelegate        WorkflowApprovalDelegate[] @relation("DelegateDelegate")

  // 員工異動紀錄
  changeLogs        EmployeeChangeLog[] @relation("EmployeeChangeLogs")
  changeLogsCreated EmployeeChangeLog[] @relation("ChangeLogCreator")

  // 內部即時訊息
  conversationParticipants ConversationParticipant[]
  messagesSent             Message[]

  // LINE 帳號連動
  lineUserId         String? // LINE 用戶 ID
  lineAccessToken    String? // LINE 存取令牌
  lineTokenExpiresAt DateTime? // LINE 令牌到期時間

  // 專案管理
  projectsManaged     Project[]               @relation("ProjectManager")
  tasksAssigned       ProjectTask[]           @relation("TaskAssignee")
  projectMemberships  ProjectMember[]         @relation("ProjectMembership")
  projectVisibilities ProjectVisibleMember[]  @relation("ProjectVisibility")
  projectComments     ProjectComment[]        @relation("ProjectCommentAuthor")
  projectMentions     ProjectCommentMention[] @relation("ProjectMention")
  projectAttachments  ProjectAttachment[]     @relation("ProjectAttachmentUploader")
  projectActivities   ProjectActivity[]       @relation("ProjectActivityActor")
  projectTemplates    ProjectTemplate[]

  // 請假
  leaveRequests               LeaveRequest[]              @relation("EmployeeLeaveRequests")
  leaveBalanceAdjustments     LeaveBalanceAdjustment[]    @relation("BalanceAdjustmentEmployee")
  leaveBalanceAdjustedBy      LeaveBalanceAdjustment[]    @relation("BalanceAdjustmentAdjuster")
  leaveTypeTemplates          LeaveTypeTemplate[]
  projectAuditLogs            ProjectAuditLog[]           @relation("EmployeeProjectAuditLogs")

  // 薪資
  salaries     EmployeeSalary[]
  payrollSlips PayrollSlip[]

  // 新版流程管理
  flowTemplatesCreated      FlowTemplate[]       @relation("FlowTemplateCreator")
  flowStepsAsApprover       FlowStep[]           @relation("FlowStepSpecificApprover")
  flowExecutionsAsApplicant FlowExecution[]      @relation("FlowExecutionApplicant")
  flowApprovalsAsAssignee   FlowApprovalRecord[] @relation("FlowApprovalAssignee")
  flowApprovalsAsActual     FlowApprovalRecord[] @relation("FlowApprovalActualApprover")

  // 職務代理
  delegationsAsDelegator  Delegation[] @relation("DelegationDelegator")
  delegationsAsDelegate   Delegation[] @relation("DelegationDelegate")
  delegationsCancelled    Delegation[] @relation("DelegationCanceller")
  delegationsCreated      Delegation[] @relation("DelegationCreator")

  @@map("employees")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

model EmployeeAssignment {
  id           String           @id @default(cuid())
  employeeId   String
  companyId    String
  departmentId String
  positionId   String
  roleId       String?
  supervisorId String? // 直屬主管
  isPrimary    Boolean          @default(false) // 是否為主要任職公司
  startDate    DateTime
  endDate      DateTime?
  status       AssignmentStatus @default(ACTIVE)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  employee     Employee             @relation(fields: [employeeId], references: [id])
  company      Company              @relation(fields: [companyId], references: [id])
  department   Department           @relation(fields: [departmentId], references: [id])
  position     Position             @relation(fields: [positionId], references: [id])
  role         Role?                @relation(fields: [roleId], references: [id])
  supervisor   EmployeeAssignment?  @relation("Supervision", fields: [supervisorId], references: [id])
  subordinates EmployeeAssignment[] @relation("Supervision")

  @@unique([employeeId, companyId])
  @@index([supervisorId]) // 查詢下屬效能優化
  @@index([companyId, departmentId, status]) // 部門查詢效能優化
  @@map("employee_assignments")
}

enum AssignmentStatus {
  ACTIVE // 在職
  ON_LEAVE // 留停
  RESIGNED // 離職
}

// ==================== 員工異動紀錄 ====================

// 異動類型
enum ChangeType {
  ONBOARD // 入職
  OFFBOARD // 離職
  REINSTATE // 復職
  TRANSFER // 調動
  ON_LEAVE // 留停
  RETURN_FROM_LEAVE // 留停復職
}

// 員工異動紀錄
model EmployeeChangeLog {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation("EmployeeChangeLogs", fields: [employeeId], references: [id])

  changeType ChangeType // 異動類型
  changeDate DateTime // 異動生效日期

  // 異動前後的資料（nullable，因為入職時沒有「前」）
  fromCompanyId    String?
  fromDepartmentId String?
  fromPositionId   String?
  toCompanyId      String?
  toDepartmentId   String?
  toPositionId     String?

  reason String? // 異動原因
  note   String? // 備註

  createdById String // 建立者（操作人）
  createdBy   Employee @relation("ChangeLogCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@index([employeeId, changeDate])
  @@index([changeType])
  @@index([createdAt])
  @@map("employee_change_logs")
}

// ==================== 權限 ====================

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false) // 系統角色不可刪除
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permissions RolePermission[]
  employees   EmployeeAssignment[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "attendance.clock", "leave.apply"
  name        String
  module      String // e.g., "attendance", "leave", "expense"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles     RolePermission[]
  employees EmployeePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model EmployeePermission {
  id           String    @id @default(cuid())
  employeeId   String
  companyId    String
  permissionId String
  grantType    GrantType
  grantedById  String? // 誰授權的
  grantedAt    DateTime  @default(now())
  expiresAt    DateTime? // 權限過期時間（可選）

  employee   Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([employeeId, companyId, permissionId])
  @@map("employee_permissions")
}

enum GrantType {
  GRANT // 授予
  REVOKE // 移除
}

// 權限範本（用於快速套用一組權限）
model PermissionTemplate {
  id          String   @id @default(cuid())
  name        String // 範本名稱
  description String? // 範本說明
  permissions Json // 權限代碼陣列 ["hr.view", "leave.approve", ...]
  isActive    Boolean  @default(true)
  createdById String // 建立者
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("permission_templates")
}

// ==================== NextAuth.js ====================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("employee_id")
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user Employee @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String   @map("employee_id")
  expires      DateTime

  user Employee @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// QR Code 登入 Token
model QrLoginToken {
  id              String        @id @default(cuid())
  token           String        @unique // QR Code 包含的 token
  status          QrLoginStatus @default(PENDING)
  employeeId      String? // 驗證後的員工 ID
  employee        Employee?     @relation(fields: [employeeId], references: [id])
  ipAddress       String? // 產生 QR 的用戶端 IP
  userAgent       String? // 產生 QR 的用戶端 UA
  createdAt       DateTime      @default(now())
  expiresAt       DateTime // 過期時間 (通常 5 分鐘)
  authenticatedAt DateTime? // 驗證時間

  @@index([token])
  @@index([status])
  @@map("qr_login_tokens")
}

enum QrLoginStatus {
  PENDING // 等待掃描
  AUTHENTICATED // 已掃描驗證
  USED // 已使用完成登入
  EXPIRED // 已過期
}

// ==================== 出勤管理 ====================

enum ShiftType {
  FIXED // 固定班
  FLEXIBLE // 彈性班
}

enum ClockMethod {
  WEB // 網頁打卡
  APP // APP打卡
  GPS // GPS定位打卡
  IP // IP限制打卡
  FACE // 人臉辨識
  MANUAL // 人工補登
}

enum AttendanceStatus {
  PENDING // 待確認
  NORMAL // 正常
  LATE // 遲到
  EARLY_LEAVE // 早退
  ABSENT // 曠職
  LEAVE // 請假
  EXEMPT // 免打卡
}

model WorkShift {
  id        String    @id @default(cuid())
  companyId String
  name      String // 班別名稱
  code      String // 班別代碼
  shiftType ShiftType @default(FIXED)

  // 固定班時間
  workStartTime String? // 上班時間 "HH:mm"
  workEndTime   String? // 下班時間 "HH:mm"

  // 彈性班設定
  coreStartTime  String? // 核心時間開始 "HH:mm"
  coreEndTime    String? // 核心時間結束 "HH:mm"
  flexStartRange String? // 彈性上班範圍 "HH:mm-HH:mm"
  flexEndRange   String? // 彈性下班範圍 "HH:mm-HH:mm"
  requiredHours  Float? // 每日應工作時數

  // 容許設定
  lateGraceMinutes       Int @default(0) // 遲到寬限分鐘
  earlyLeaveGraceMinutes Int @default(0) // 早退寬限分鐘
  overtimeThreshold      Int @default(30) // 加班起算分鐘數

  // 工作日設定
  workDays String @default("1,2,3,4,5") // 工作日（週一=1）

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company     Company           @relation(fields: [companyId], references: [id])
  breaks      ShiftBreak[]
  assignments ShiftAssignment[]

  @@unique([companyId, code])
  @@map("work_shifts")
}

model ShiftBreak {
  id         String  @id @default(cuid())
  shiftId    String
  name       String // 休息名稱（如：午休、下午茶）
  startTime  String // 開始時間 "HH:mm"
  endTime    String // 結束時間 "HH:mm"
  isPaid     Boolean @default(false) // 是否為有薪休息
  isRequired Boolean @default(true) // 是否為必要休息
  sortOrder  Int     @default(0)

  shift WorkShift @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@map("shift_breaks")
}

model ShiftAssignment {
  id            String    @id @default(cuid())
  employeeId    String
  companyId     String
  shiftId       String
  effectiveDate DateTime  @db.Date // 生效日期
  endDate       DateTime? @db.Date // 結束日期
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  company Company   @relation(fields: [companyId], references: [id])
  shift   WorkShift @relation(fields: [shiftId], references: [id])

  @@unique([employeeId, companyId, effectiveDate])
  @@map("shift_assignments")
}

model AttendanceRecord {
  id         String   @id @default(cuid())
  employeeId String
  companyId  String
  date       DateTime @db.Date // 出勤日期

  // 上班打卡
  clockInTime     DateTime?
  clockInMethod   ClockMethod?
  clockInLocation String? // GPS座標或地點描述
  clockInIp       String?

  // 下班打卡
  clockOutTime     DateTime?
  clockOutMethod   ClockMethod?
  clockOutLocation String?
  clockOutIp       String?

  // 出勤狀態
  status            AttendanceStatus @default(PENDING)
  lateMinutes       Int              @default(0) // 遲到分鐘數
  earlyLeaveMinutes Int              @default(0) // 早退分鐘數
  overtimeMinutes   Int              @default(0) // 加班分鐘數
  workHours         Float? // 實際工作時數

  // 補登資訊
  isAmended    Boolean @default(false) // 是否為補登
  amendReason  String? // 補登原因
  approvedById String? // 審核人

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id])

  @@unique([employeeId, companyId, date])
  @@index([companyId, date]) // 報表查詢效能優化
  @@map("attendance_records")
}

// ==================== 請假管理 ====================

model LeaveType {
  id        String        @id @default(cuid())
  companyId String? // NULL = 集團共用法定假別
  code      String // ANNUAL, SICK, PERSONAL, etc.
  name      String
  category  LeaveCategory @default(STATUTORY)

  // 請假規則
  requiresReason      Boolean   @default(true)
  requiresAttachment  Boolean   @default(false)
  attachmentAfterDays Int       @default(0)
  minUnit             LeaveUnit @default(HOUR)

  // 額度規則
  quotaType          QuotaType @default(FIXED)
  annualQuotaDays    Float     @default(0)
  canCarryOver       Boolean   @default(false)
  carryOverLimitDays Float     @default(0)
  canCashOut         Boolean   @default(false)
  cashOutRate        Float     @default(1.0)

  // 使用限制
  advanceDaysRequired Int     @default(0)
  maxConsecutiveDays  Int     @default(0)
  genderRestriction   Gender?
  applicableAfterDays Int     @default(0)

  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company     Company?                  @relation(fields: [companyId], references: [id])
  requests    LeaveRequest[]
  balances    LeaveBalance[]
  adjustments LeaveBalanceAdjustment[]

  @@unique([companyId, code])
  @@map("leave_types")
}

enum LeaveCategory {
  STATUTORY
  COMPANY
}

enum LeaveUnit {
  HOUR
  HALF_DAY
  DAY
}

enum QuotaType {
  FIXED
  SENIORITY
  UNLIMITED
}

// 特休計算制度
enum AnnualLeaveMethod {
  ANNIVERSARY // 週年制（以到職日為起算點）
  CALENDAR    // 曆年制（以每年 1/1 為起算點）
}

model LeaveRequest {
  id          String @id @default(cuid())
  requestNo   String @unique
  employeeId  String
  companyId   String
  leaveTypeId String

  startDate   DateTime
  startPeriod LeavePeriod @default(FULL_DAY)
  endDate     DateTime
  endPeriod   LeavePeriod @default(FULL_DAY)
  totalHours  Float

  reason          String?
  attachments     String?
  proxyEmployeeId String?

  status      LeaveStatus @default(DRAFT)
  submittedAt DateTime?
  processedAt DateTime?

  currentApproverId String?
  approvedById      String?
  rejectedById      String?
  approvalComment   String?

  actualEndDate  DateTime?
  cancelledHours Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])
  employee  Employee  @relation("EmployeeLeaveRequests", fields: [employeeId], references: [id])

  @@index([employeeId, companyId])
  @@index([status])
  @@index([employeeId, companyId, status]) // 複合索引優化查詢效能
  @@map("leave_requests")
}

enum LeavePeriod {
  FULL_DAY
  AM
  PM
}

enum LeaveStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model LeaveBalance {
  id          String @id @default(cuid())
  employeeId  String
  companyId   String
  leaveTypeId String
  year        Int

  entitledHours Float @default(0)
  carriedHours  Float @default(0)
  adjustedHours Float @default(0)

  usedHours    Float @default(0)
  pendingHours Float @default(0)

  cashedOutHours Float @default(0)
  cashOutAmount  Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@unique([employeeId, companyId, leaveTypeId, year])
  @@map("leave_balances")
}

// 假別餘額調整記錄（稽核用）
model LeaveBalanceAdjustment {
  id          String @id @default(cuid())
  employeeId  String
  companyId   String
  leaveTypeId String
  year        Int

  previousHours Float  // 調整前時數
  newHours      Float  // 調整後時數
  changeHours   Float  // 變動時數
  reason        String // 調整原因

  adjustedById String   // 調整者
  adjustedAt   DateTime @default(now())

  employee   Employee  @relation("BalanceAdjustmentEmployee", fields: [employeeId], references: [id])
  adjustedBy Employee  @relation("BalanceAdjustmentAdjuster", fields: [adjustedById], references: [id])
  leaveType  LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@index([employeeId, companyId, year])
  @@map("leave_balance_adjustments")
}

// 假別範本
model LeaveTypeTemplate {
  id              String  @id @default(cuid())
  name            String  // 範本名稱
  description     String?
  year            Int?    // 適用年度（null = 通用範本）
  sourceCompanyId String? // 來源公司

  items LeaveTypeTemplateItem[]

  createdById String
  createdBy   Employee @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("leave_type_templates")
}

// 假別範本項目
model LeaveTypeTemplateItem {
  id         String            @id @default(cuid())
  templateId String
  template   LeaveTypeTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  code                String
  name                String
  category            LeaveCategory
  requiresReason      Boolean   @default(true)
  requiresAttachment  Boolean   @default(false)
  attachmentAfterDays Int       @default(0)
  minUnit             LeaveUnit @default(HOUR)
  quotaType           QuotaType @default(FIXED)
  annualQuotaDays     Float     @default(0)
  canCarryOver        Boolean   @default(false)
  carryOverLimitDays  Float     @default(0)
  canCashOut          Boolean   @default(false)
  cashOutRate         Float     @default(1.0)
  advanceDaysRequired Int       @default(0)
  maxConsecutiveDays  Int       @default(0)
  genderRestriction   Gender?
  applicableAfterDays Int       @default(0)
  sortOrder           Int       @default(0)

  @@map("leave_type_template_items")
}

// ==================== 組織圖 ====================

// 組織圖類型
enum OrgChartType {
  GROUP // 集團組織圖
  COMPANY // 公司組織圖
}

// 組織節點類型
enum OrgNodeType {
  DEPARTMENT // 部門
  POSITION // 職位
  EMPLOYEE // 員工
  TEAM // 團隊
  DIVISION // 事業部
  COMMITTEE // 委員會
  COMPANY // 公司
  EXTERNAL // 外部單位
}

// 組織關係類型
enum OrgRelationType {
  SOLID // 實線（正式彙報）
  DOTTED // 虛線（功能性彙報）
  MATRIX // 矩陣（多重隸屬）
}

// 組織圖
model OrgChart {
  id          String       @id @default(cuid())
  type        OrgChartType
  groupId     String?
  group       Group?       @relation(fields: [groupId], references: [id])
  companyId   String?
  company     Company?     @relation("CompanyOrgCharts", fields: [companyId], references: [id])
  name        String
  description String?
  isActive    Boolean      @default(true)

  nodes     OrgNode[]
  relations OrgRelation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([groupId])
  @@index([companyId])
  @@map("org_charts")
}

// 組織節點
model OrgNode {
  id      String   @id @default(cuid())
  chartId String
  chart   OrgChart @relation(fields: [chartId], references: [id], onDelete: Cascade)

  nodeType    OrgNodeType
  referenceId String? // 關聯的 departmentId/positionId/employeeId

  // 視覺化位置
  posX Float @default(0)
  posY Float @default(0)

  // 自訂顯示
  label String?

  fromRelations OrgRelation[] @relation("FromOrgNode")
  toRelations   OrgRelation[] @relation("ToOrgNode")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chartId])
  @@index([referenceId])
  @@map("org_nodes")
}

// 組織關係
model OrgRelation {
  id      String   @id @default(cuid())
  chartId String
  chart   OrgChart @relation(fields: [chartId], references: [id], onDelete: Cascade)

  fromNodeId String
  fromNode   OrgNode @relation("FromOrgNode", fields: [fromNodeId], references: [id], onDelete: Cascade)
  toNodeId   String
  toNode     OrgNode @relation("ToOrgNode", fields: [toNodeId], references: [id], onDelete: Cascade)

  relationType OrgRelationType @default(SOLID)

  // 簽核相關設定
  includeInApproval Boolean @default(true)
  approvalOrder     Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([chartId, fromNodeId, toNodeId])
  @@index([chartId])
  @@map("org_relations")
}

// ==================== 工作流程引擎 ====================

// 流程範圍
enum WorkflowScope {
  EMPLOYEE // 員工特殊路徑
  REQUEST_TYPE // 申請類型流程
  DEFAULT // 預設流程
}

// 流程節點類型
enum WorkflowNodeType {
  START // 開始
  APPROVAL // 簽核
  CONDITION // 條件判斷
  PARALLEL_START // 並行開始
  PARALLEL_JOIN // 並行匯合
  END // 結束
}

// 簽核人指定類型
enum WorkflowApproverType {
  SPECIFIC_EMPLOYEE // 特定員工
  POSITION // 職位
  ROLE // 角色
  ORG_RELATION // 組織關係
  DEPARTMENT_HEAD // 部門主管
  CUSTOM_FIELD // 自訂欄位
}

// 組織關係簽核人類型
enum OrgRelationApproverType {
  DIRECT_SUPERVISOR // 直屬主管
  DOTTED_SUPERVISOR // 虛線主管
  N_LEVEL_UP // 往上N層
  DEPARTMENT_MANAGER // 部門最高主管
  COMPANY_HEAD // 公司負責人
}

// 並行模式
enum WorkflowParallelMode {
  ALL // 全部通過
  ANY // 任一通過
  MAJORITY // 多數通過
}

// 條件運算子
enum WorkflowConditionOperator {
  EQUALS
  NOT_EQUALS
  GREATER_THAN
  LESS_THAN
  GREATER_OR_EQUAL
  LESS_OR_EQUAL
  CONTAINS
  IN
  NOT_IN
}

// 流程實例狀態
enum WorkflowInstanceStatus {
  DRAFT
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  CANCELLED
  WITHDRAWN
}

// 簽核紀錄狀態
enum WorkflowApprovalStatus {
  WAITING
  PENDING
  APPROVED
  REJECTED
  SKIPPED
}

// 簽核動作
enum WorkflowApprovalAction {
  APPROVE
  REJECT
  RETURN
  ADD_SIGNER
  TRANSFER
}

// 流程定義
model WorkflowDefinition {
  id          String  @id @default(cuid())
  name        String
  description String?

  // 適用範圍
  scopeType WorkflowScope
  groupId   String?
  group     Group?        @relation(fields: [groupId], references: [id])
  companyId String?
  company   Company?      @relation("CompanyWorkflows", fields: [companyId], references: [id])

  // 員工特殊路徑
  employeeId String?
  employee   Employee? @relation("EmployeeWorkflows", fields: [employeeId], references: [id])

  // 申請類型
  requestType String?

  // 生效期間
  effectiveFrom DateTime?
  effectiveTo   DateTime?
  isActive      Boolean   @default(true)

  // 版本控制
  version Int @default(1)

  // 設定者
  createdById String
  createdBy   Employee @relation("WorkflowCreator", fields: [createdById], references: [id])

  nodes     WorkflowNode[]
  edges     WorkflowEdge[]
  instances WorkflowInstance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([employeeId])
  @@index([requestType])
  @@index([scopeType, isActive])
  @@map("workflow_definitions")
}

// 流程節點
model WorkflowNode {
  id           String             @id @default(cuid())
  definitionId String
  definition   WorkflowDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)

  nodeType WorkflowNodeType
  name     String?

  // 簽核人設定
  approverType    WorkflowApproverType?
  approverId      String?
  orgRelation     OrgRelationApproverType?
  orgLevelUp      Int?
  customFieldName String?

  // 並行設定
  parallelMode WorkflowParallelMode?

  // 視覺化位置
  posX Float @default(0)
  posY Float @default(0)

  fromEdges       WorkflowEdge[]           @relation("FromWorkflowNode")
  toEdges         WorkflowEdge[]           @relation("ToWorkflowNode")
  approvalRecords WorkflowApprovalRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([definitionId])
  @@map("workflow_nodes")
}

// 節點連線
model WorkflowEdge {
  id           String             @id @default(cuid())
  definitionId String
  definition   WorkflowDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)

  fromNodeId String
  fromNode   WorkflowNode @relation("FromWorkflowNode", fields: [fromNodeId], references: [id], onDelete: Cascade)
  toNodeId   String
  toNode     WorkflowNode @relation("ToWorkflowNode", fields: [toNodeId], references: [id], onDelete: Cascade)

  // 條件設定
  conditionField    String?
  conditionOperator WorkflowConditionOperator?
  conditionValue    String?
  isDefault         Boolean                    @default(false)

  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([definitionId])
  @@index([fromNodeId])
  @@map("workflow_edges")
}

// 流程實例
model WorkflowInstance {
  id           String             @id @default(cuid())
  definitionId String
  definition   WorkflowDefinition @relation(fields: [definitionId], references: [id])

  // 關聯申請單
  requestType String
  requestId   String

  // 申請人
  applicantId String
  applicant   Employee @relation(fields: [applicantId], references: [id])
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])

  // 狀態
  status        WorkflowInstanceStatus @default(DRAFT)
  currentNodeId String?

  // 時間戳
  submittedAt DateTime?
  completedAt DateTime?

  approvalRecords WorkflowApprovalRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([requestType, requestId])
  @@index([applicantId])
  @@index([companyId])
  @@index([status])
  @@map("workflow_instances")
}

// 簽核紀錄
model WorkflowApprovalRecord {
  id         String           @id @default(cuid())
  instanceId String
  instance   WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  nodeId     String
  node       WorkflowNode     @relation(fields: [nodeId], references: [id])

  // 簽核人
  approverId     String
  approver       Employee  @relation("WorkflowApprover", fields: [approverId], references: [id])
  actualSignerId String?
  actualSigner   Employee? @relation("WorkflowActualSigner", fields: [actualSignerId], references: [id])

  // 簽核結果
  status  WorkflowApprovalStatus  @default(WAITING)
  action  WorkflowApprovalAction?
  comment String?

  // 時間
  assignedAt DateTime  @default(now())
  actionAt   DateTime?

  // 加簽/轉簽/退回
  addedSignerIds  String[]
  transferredToId String?
  returnToNodeId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([instanceId])
  @@index([approverId])
  @@index([status])
  @@map("workflow_approval_records")
}

// 職務代理
model WorkflowApprovalDelegate {
  id          String   @id @default(cuid())
  principalId String
  principal   Employee @relation("DelegatePrincipal", fields: [principalId], references: [id])
  delegateId  String
  delegate    Employee @relation("DelegateDelegate", fields: [delegateId], references: [id])

  startDate DateTime
  endDate   DateTime

  // 代理範圍
  requestTypes String[]
  companyIds   String[]

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([principalId])
  @@index([delegateId])
  @@index([startDate, endDate])
  @@map("workflow_approval_delegates")
}

// ==================== 審核流程引擎 ====================

// 審核流程模板
model ApprovalFlow {
  id          String  @id @default(cuid())
  companyId   String? // NULL = 集團通用
  code        String // LEAVE, EXPENSE, OVERTIME, etc.
  name        String
  description String?
  module      String // leave, expense, overtime, etc.

  // 條件觸發（JSON 格式）
  conditions String?

  isActive  Boolean  @default(true)
  isDefault Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company?           @relation(fields: [companyId], references: [id])
  steps     ApprovalStep[]
  instances ApprovalInstance[]

  @@unique([companyId, code])
  @@map("approval_flows")
}

// 審核關卡
model ApprovalStep {
  id        String @id @default(cuid())
  flowId    String
  stepOrder Int
  name      String

  approverType  ApproverType
  approverValue String?

  approvalMode ApprovalMode @default(ANY)

  canSkip       Boolean @default(false)
  skipCondition String?

  ccType  ApproverType?
  ccValue String?

  timeoutHours  Int           @default(0)
  timeoutAction TimeoutAction @default(NONE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  flow          ApprovalFlow           @relation(fields: [flowId], references: [id], onDelete: Cascade)
  stepInstances ApprovalStepInstance[]

  @@unique([flowId, stepOrder])
  @@map("approval_steps")
}

enum ApproverType {
  SUPERVISOR
  DEPARTMENT_HEAD
  POSITION_LEVEL
  SPECIFIC_POSITION
  SPECIFIC_EMPLOYEE
  ROLE
}

enum ApprovalMode {
  ANY
  ALL
  MAJORITY
}

enum TimeoutAction {
  NONE
  REMIND
  ESCALATE
  AUTO_APPROVE
  AUTO_REJECT
}

// 審核流程實例
model ApprovalInstance {
  id     String @id @default(cuid())
  flowId String

  module      String
  referenceId String

  applicantId String
  companyId   String

  status      ApprovalInstanceStatus @default(IN_PROGRESS)
  currentStep Int                    @default(1)

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  flow          ApprovalFlow           @relation(fields: [flowId], references: [id])
  stepInstances ApprovalStepInstance[]

  @@unique([module, referenceId])
  @@index([applicantId, companyId])
  @@index([status])
  @@map("approval_instances")
}

enum ApprovalInstanceStatus {
  IN_PROGRESS
  APPROVED
  REJECTED
  CANCELLED
}

// 審核關卡實例
model ApprovalStepInstance {
  id         String @id @default(cuid())
  instanceId String
  stepId     String
  stepOrder  Int

  assignedTo String // JSON array of employeeIds

  status StepInstanceStatus @default(PENDING)

  assignedAt  DateTime  @default(now())
  dueAt       DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  instance ApprovalInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  step     ApprovalStep     @relation(fields: [stepId], references: [id])
  actions  ApprovalAction[]

  @@unique([instanceId, stepOrder])
  @@map("approval_step_instances")
}

enum StepInstanceStatus {
  PENDING
  APPROVED
  REJECTED
  SKIPPED
}

// 審核動作記錄
model ApprovalAction {
  id             String @id @default(cuid())
  stepInstanceId String

  actorId String

  action  ActionType
  comment String?

  actedAt DateTime @default(now())

  stepInstance ApprovalStepInstance @relation(fields: [stepInstanceId], references: [id], onDelete: Cascade)

  @@map("approval_actions")
}

enum ActionType {
  APPROVE
  REJECT
  RETURN
  DELEGATE
  CC
}

// ==================== 費用報銷 ====================

// 費用類別
model ExpenseCategory {
  id          String  @id @default(cuid())
  companyId   String? // NULL = 集團通用
  code        String // TRAVEL, MEAL, TRANSPORT, SUPPLIES, etc.
  name        String
  description String?

  // 報銷規則
  requiresReceipt     Boolean @default(true) // 是否需要發票/收據
  maxAmountPerItem    Float? // 單項最高金額限制
  maxAmountPerMonth   Float? // 每月最高金額限制
  requiresPreApproval Boolean @default(false) // 是否需要事前核准

  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company?      @relation(fields: [companyId], references: [id])
  items   ExpenseItem[]

  @@unique([companyId, code])
  @@map("expense_categories")
}

// 費用報銷申請
model ExpenseRequest {
  id         String @id @default(cuid())
  requestNo  String @unique // 申請單號
  employeeId String
  companyId  String

  // 報銷期間
  periodStart DateTime @db.Date // 報銷起始日
  periodEnd   DateTime @db.Date // 報銷結束日

  // 金額
  totalAmount Float  @default(0) // 總金額
  currency    String @default("TWD")

  // 說明
  title       String // 報銷標題
  description String? // 說明

  // 狀態
  status      ExpenseStatus @default(DRAFT)
  submittedAt DateTime?
  processedAt DateTime?

  // 審核資訊
  currentApproverId String?
  approvedById      String?
  rejectedById      String?
  approvalComment   String?

  // 付款資訊
  paymentStatus PaymentStatus @default(UNPAID)
  paidAt        DateTime?
  paymentRef    String? // 付款參考號

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items ExpenseItem[]

  @@index([employeeId, companyId])
  @@index([status])
  @@index([employeeId, companyId, status]) // 複合索引優化查詢效能
  @@map("expense_requests")
}

enum ExpenseStatus {
  DRAFT // 草稿
  PENDING // 審核中
  APPROVED // 已核准
  REJECTED // 已拒絕
  CANCELLED // 已取消
}

enum PaymentStatus {
  UNPAID // 未付款
  PROCESSING // 處理中
  PAID // 已付款
}

// ==================== 財務會計 Enums ====================

// 會計科目類別
enum AccountCategory {
  ASSET // 資產
  LIABILITY // 負債
  EQUITY // 權益
  REVENUE // 收入
  EXPENSE // 費用
}

// 科目性質
enum AccountType {
  DEBIT // 借方科目
  CREDIT // 貸方科目
}

// 傳票類型
enum VoucherType {
  RECEIPT // 收款傳票
  PAYMENT // 付款傳票
  TRANSFER // 轉帳傳票
}

// 傳票來源
enum VoucherSource {
  MANUAL // 人工輸入
  EXPENSE // 費用報支
  AR // 應收帳款
  AP // 應付帳款
}

// 傳票狀態
enum VoucherStatus {
  DRAFT // 草稿
  PENDING // 待審核
  POSTED // 已過帳
  VOID // 作廢
}

// 會計期間狀態
enum PeriodStatus {
  OPEN // 開放
  CLOSED // 已結帳
  LOCKED // 已鎖定
}

// 應收應付狀態
enum ARAPStatus {
  OPEN // 未收付
  PARTIAL // 部分收付
  PAID // 已收付
  VOID // 作廢
}

// 費用明細項目
model ExpenseItem {
  id         String @id @default(cuid())
  requestId  String
  categoryId String

  // 費用資訊
  date        DateTime @db.Date // 消費日期
  description String // 費用說明
  amount      Float // 金額
  currency    String   @default("TWD")

  // 發票/收據
  receiptNo   String? // 發票號碼
  receiptDate DateTime? // 發票日期
  vendorName  String? // 廠商名稱
  taxId       String? // 統一編號

  // 附件
  attachments String? // JSON array of file URLs

  // 備註
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  request  ExpenseRequest  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  category ExpenseCategory @relation(fields: [categoryId], references: [id])

  @@map("expense_items")
}

// ==================== 財務會計 ====================

// 會計科目表
model AccountChart {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  code        String
  name        String
  category    AccountCategory
  accountType AccountType
  level       Int

  parentId String?
  parent   AccountChart?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children AccountChart[] @relation("AccountHierarchy")

  isDetail    Boolean @default(true)
  isActive    Boolean @default(true)
  isSystem    Boolean @default(false)
  requiresAux Boolean @default(false)

  openingBalance Decimal @default(0) @db.Decimal(15, 2)

  voucherLines VoucherLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, code])
  @@index([companyId, category])
  @@map("account_charts")
}

// 會計期間
model AccountingPeriod {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  year      Int
  period    Int
  startDate DateTime
  endDate   DateTime

  status   PeriodStatus @default(OPEN)
  closedAt DateTime?
  closedBy String?

  vouchers Voucher[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, year, period])
  @@map("accounting_periods")
}

// 客戶
model Customer {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  code         String
  name         String
  taxId        String?
  contactName  String?
  contactPhone String?
  contactEmail String?
  address      String?
  paymentTerms Int      @default(30)
  creditLimit  Decimal? @db.Decimal(15, 2)

  isActive Boolean @default(true)

  receivables  AccountReceivable[]
  voucherLines VoucherLine[]

  // 專案管理
  projects Project[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, code])
  @@map("customers")
}

// 供應商
model Vendor {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  code         String
  name         String
  taxId        String?
  contactName  String?
  contactPhone String?
  contactEmail String?
  address      String?
  paymentTerms Int     @default(30)
  bankName     String?
  bankAccount  String?

  isActive Boolean @default(true)

  payables     AccountPayable[]
  voucherLines VoucherLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, code])
  @@map("vendors")
}

// 傳票
model Voucher {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  voucherNo   String
  voucherDate DateTime
  voucherType VoucherType
  sourceType  VoucherSource @default(MANUAL)
  sourceId    String?

  periodId String
  period   AccountingPeriod @relation(fields: [periodId], references: [id])

  description String?
  totalDebit  Decimal @db.Decimal(15, 2)
  totalCredit Decimal @db.Decimal(15, 2)

  status   VoucherStatus @default(DRAFT)
  postedAt DateTime?

  createdById  String
  createdBy    Employee  @relation("VoucherCreator", fields: [createdById], references: [id])
  approvedById String?
  approvedBy   Employee? @relation("VoucherApprover", fields: [approvedById], references: [id])
  postedById   String?
  postedBy     Employee? @relation("VoucherPoster", fields: [postedById], references: [id])

  lines VoucherLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, voucherNo])
  @@index([companyId, voucherDate])
  @@index([companyId, status])
  @@map("vouchers")
}

// 傳票分錄
model VoucherLine {
  id        String  @id @default(cuid())
  voucherId String
  voucher   Voucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  lineNo    Int
  accountId String
  account   AccountChart @relation(fields: [accountId], references: [id])

  debitAmount  Decimal @default(0) @db.Decimal(15, 2)
  creditAmount Decimal @default(0) @db.Decimal(15, 2)
  description  String?

  customerId   String?
  customer     Customer?   @relation(fields: [customerId], references: [id])
  vendorId     String?
  vendor       Vendor?     @relation(fields: [vendorId], references: [id])
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  createdAt DateTime @default(now())

  @@index([voucherId])
  @@map("voucher_lines")
}

// 應收帳款
model AccountReceivable {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  arNo    String
  arDate  DateTime
  dueDate DateTime

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  amount     Decimal @db.Decimal(15, 2)
  paidAmount Decimal @default(0) @db.Decimal(15, 2)
  balance    Decimal @db.Decimal(15, 2)

  invoiceNo   String?
  invoiceDate DateTime?
  description String?

  status ARAPStatus @default(OPEN)

  voucherId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, arNo])
  @@index([companyId, customerId])
  @@index([companyId, status])
  @@map("account_receivables")
}

// 應付帳款
model AccountPayable {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  apNo    String
  apDate  DateTime
  dueDate DateTime

  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  amount     Decimal @db.Decimal(15, 2)
  paidAmount Decimal @default(0) @db.Decimal(15, 2)
  balance    Decimal @db.Decimal(15, 2)

  invoiceNo   String?
  invoiceDate DateTime?
  description String?

  status ARAPStatus @default(OPEN)

  voucherId        String?
  expenseRequestId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, apNo])
  @@index([companyId, vendorId])
  @@index([companyId, status])
  @@map("account_payables")
}

// ==================== 用印申請 ====================

// 用印類型
enum SealType {
  COMPANY_SEAL // 公司章 (合併原公司大章與公司小章)
  CONTRACT_SEAL // 合約用印
  INVOICE_SEAL // 發票章
  BOARD_SEAL // 董事會印鑑
  BANK_SEAL // 銀行印鑑
  PERFORATION_SEAL // 騎縫章
}

// 用印申請狀態
enum SealRequestStatus {
  DRAFT // 草稿
  PENDING // 待審核
  APPROVED // 已核准
  REJECTED // 已駁回
  PROCESSING // 處理中 (用印中)
  COMPLETED // 已完成
  CANCELLED // 已取消
}

// 用印申請
model SealRequest {
  id          String   @id @default(cuid())
  requestNo   String   @unique // SR202601-0001
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  applicantId String
  applicant   Employee @relation("SealApplicant", fields: [applicantId], references: [id])

  sealTypes     Json    @default("[]") // 印章類型陣列 e.g., ["COMPANY_SEAL", "PERFORATION_SEAL"]
  purpose       String // 用途說明
  documentName  String? // 文件名稱
  documentCount Int     @default(1) // 用印份數

  isCarryOut     Boolean   @default(false) // 是否攜出
  expectedReturn DateTime? // 預計歸還時間
  actualReturn   DateTime? // 實際歸還時間
  returnNote     String? // 歸還備註

  status      SealRequestStatus @default(DRAFT)
  attachments Json? // 附件 [{name, url}]

  // 審批相關
  approvalInstanceId String? // 關聯的審批流程實例
  processedById      String? // 處理人 (行政人員)
  processedBy        Employee? @relation("SealProcessor", fields: [processedById], references: [id])
  processedAt        DateTime? // 處理時間
  completedAt        DateTime? // 完成時間

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([applicantId])
  @@index([status])
  @@index([isCarryOut, status])
  @@map("seal_requests")
}

// ==================== 名片申請 ====================

// 名片申請狀態
enum CardRequestStatus {
  DRAFT // 草稿
  PENDING // 待審核
  APPROVED // 已核准
  REJECTED // 已駁回
  PRINTING // 印刷中
  COMPLETED // 已完成
  CANCELLED // 已取消
}

// 名片申請
model BusinessCardRequest {
  id        String @id @default(cuid())
  requestNo String @unique // BC202601-0001

  // 申請對象公司
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  // 申請人
  applicantId String
  applicant   Employee @relation("CardApplicant", fields: [applicantId], references: [id])

  // 名片資料
  name       String // 姓名
  nameEn     String? // 英文名
  title      String // 職稱
  titleEn    String? // 英文職稱
  department String? // 部門名稱
  phone      String? // 公司電話
  mobile     String? // 手機
  fax        String? // 傳真
  email      String? // Email
  address    String? // 公司地址
  quantity   Int     @default(100) // 數量（盒）
  note       String? // 備註

  // 狀態流程
  status       CardRequestStatus @default(DRAFT)
  approvedById String?
  approvedBy   Employee?         @relation("CardApprover", fields: [approvedById], references: [id])
  approvedAt   DateTime?
  printedAt    DateTime? // 印刷完成時間

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([applicantId])
  @@index([status])
  @@map("business_card_requests")
}

// ==================== 文具申請 ====================

// 文具申請狀態
enum StationeryRequestStatus {
  DRAFT // 草稿
  PENDING // 待審核
  APPROVED // 已核准
  REJECTED // 已駁回
  ISSUED // 已發放
  CANCELLED // 已取消
}

// 文具品項
model StationeryItem {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  code       String // 品項代碼 ST001
  name       String // 原子筆、便條紙...
  unit       String // 個、盒、本
  unitPrice  Decimal @db.Decimal(10, 2) // 單價
  stock      Int     @default(0) // 現有庫存
  alertLevel Int     @default(10) // 警戒庫存
  isActive   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, code])
  @@index([companyId])
  @@map("stationery_items")
}

// 文具申請單
model StationeryRequest {
  id        String @id @default(cuid())
  requestNo String @unique // ST202601-0001

  // 申請對象公司
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  // 申請人
  applicantId String
  applicant   Employee @relation("StationeryApplicant", fields: [applicantId], references: [id])

  // 申請明細 [{itemId, itemCode, itemName, quantity, unitPrice, subtotal}]
  items       Json
  totalAmount Decimal @db.Decimal(10, 2)
  purpose     String? // 用途說明

  // 狀態流程
  status       StationeryRequestStatus @default(DRAFT)
  approvedById String?
  approvedBy   Employee?               @relation("StationeryApprover", fields: [approvedById], references: [id])
  approvedAt   DateTime?

  // 發放資訊
  issuedAt   DateTime? // 發放時間
  issuedById String? // 發放人
  issuedBy   Employee? @relation("StationeryIssuer", fields: [issuedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([applicantId])
  @@index([status])
  @@map("stationery_requests")
}

// ==================== 使用者偏好設定 ====================

model UserPreference {
  id         String   @id @default(cuid())
  employeeId String   @unique
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // 側邊欄設定 JSON: { menuOrder: string[], hiddenMenus: string[] }
  sidebarConfig Json?

  // 主題設定 JSON: { theme: string }
  themeConfig Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_preferences")
}

// ==================== 系統設定 ====================

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// ==================== 系統通知 ====================

model Notification {
  id     String   @id @default(cuid())
  userId String
  user   Employee @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  type    String // REQUEST_APPROVED, REQUEST_REJECTED, REVISION_REQUIRED, APPROVAL_NEEDED
  title   String
  message String
  link    String? // URL to navigate to when clicked

  refType String // LeaveRequest, ExpenseRequest, SealRequest, etc.
  refId   String

  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ==================== 內部即時訊息 ====================

model Conversation {
  id        String   @id @default(cuid())
  type      String   @default("DIRECT") // DIRECT (一對一), GROUP (群組)
  name      String? // 群組對話名稱（一對一為 null）
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  employeeId     String
  employee       Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  joinedAt       DateTime     @default(now())
  lastReadAt     DateTime? // 最後已讀時間，用於計算未讀訊息

  @@unique([conversationId, employeeId])
  @@index([employeeId])
  @@map("conversation_participants")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         Employee     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  content        String       @db.Text
  isDeleted      Boolean      @default(false) // 軟刪除，顯示「訊息已收回」
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  attachments MessageAttachment[]

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@map("messages")
}

model MessageAttachment {
  id        String   @id @default(cuid())
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  fileName  String // 原始檔名
  fileType  String // MIME type
  fileSize  Int // bytes
  fileUrl   String // 檔案 URL
  createdAt DateTime @default(now())

  @@index([messageId])
  @@map("message_attachments")
}

// ==================== 專案管理列舉 ====================

enum ProjectType {
  INTERNAL
  CLIENT
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ProjectVisibility {
  PRIVATE
  DEPARTMENT
  COMPANY
  CUSTOM
}

enum ProjectRole {
  MANAGER
  MEMBER
  OBSERVER
}

enum PhaseStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
}

enum TaskPriority {
  HIGH
  MEDIUM
  LOW
}

// ==================== 專案管理 ====================

model Project {
  id          String            @id @default(cuid())
  name        String
  description String?           @db.Text
  type        ProjectType
  status      ProjectStatus     @default(PLANNING)
  visibility  ProjectVisibility @default(DEPARTMENT)

  plannedStartDate DateTime?
  plannedEndDate   DateTime?
  actualStartDate  DateTime?
  actualEndDate    DateTime?

  companyId    String
  departmentId String
  managerId    String
  customerId   String?
  templateId   String?

  qualityScore Int?

  company    Company    @relation(fields: [companyId], references: [id])
  department Department @relation(fields: [departmentId], references: [id])
  manager    Employee   @relation("ProjectManager", fields: [managerId], references: [id])
  customer   Customer?  @relation(fields: [customerId], references: [id])

  phases         ProjectPhase[]
  members        ProjectMember[]
  visibleMembers ProjectVisibleMember[]
  comments       ProjectComment[]
  attachments    ProjectAttachment[]
  activities     ProjectActivity[]
  auditLogs      ProjectAuditLog[]      @relation("ProjectAuditLogs")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([departmentId])
  @@index([managerId])
  @@index([status])
  @@map("projects")
}

model ProjectPhase {
  id             String      @id @default(cuid())
  projectId      String
  name           String
  description    String?     @db.Text
  sortOrder      Int
  status         PhaseStatus @default(PENDING)
  plannedEndDate DateTime?
  actualEndDate  DateTime?

  project     Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       ProjectTask[]
  comments    ProjectComment[]
  attachments ProjectAttachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@map("project_phases")
}

model ProjectTask {
  id          String       @id @default(cuid())
  phaseId     String
  parentId    String?
  name        String
  description String?      @db.Text
  priority    TaskPriority @default(MEDIUM)
  status      TaskStatus   @default(TODO)

  assigneeId     String?
  estimatedHours Float?
  actualHours    Float?
  startDate      DateTime?
  dueDate        DateTime?
  completedAt    DateTime?

  phase       ProjectPhase        @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  parent      ProjectTask?        @relation("SubTasks", fields: [parentId], references: [id])
  children    ProjectTask[]       @relation("SubTasks")
  assignee    Employee?           @relation("TaskAssignee", fields: [assigneeId], references: [id])
  comments    ProjectComment[]
  attachments ProjectAttachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phaseId])
  @@index([parentId])
  @@index([assigneeId])
  @@index([status])
  @@map("project_tasks")
}

model ProjectMember {
  id         String      @id @default(cuid())
  projectId  String
  employeeId String
  role       ProjectRole @default(MEMBER)
  joinedAt   DateTime    @default(now())
  leftAt     DateTime?

  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  employee Employee @relation("ProjectMembership", fields: [employeeId], references: [id])

  @@unique([projectId, employeeId])
  @@index([projectId])
  @@index([employeeId])
  @@map("project_members")
}

model ProjectVisibleMember {
  id         String @id @default(cuid())
  projectId  String
  employeeId String

  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  employee Employee @relation("ProjectVisibility", fields: [employeeId], references: [id])

  @@unique([projectId, employeeId])
  @@map("project_visible_members")
}

model ProjectComment {
  id        String  @id @default(cuid())
  projectId String?
  phaseId   String?
  taskId    String?
  authorId  String
  content   String  @db.Text

  project     Project?                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  phase       ProjectPhase?           @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  task        ProjectTask?            @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author      Employee                @relation("ProjectCommentAuthor", fields: [authorId], references: [id])
  attachments ProjectAttachment[]
  mentions    ProjectCommentMention[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([phaseId])
  @@index([taskId])
  @@index([authorId])
  @@map("project_comments")
}

model ProjectCommentMention {
  id         String @id @default(cuid())
  commentId  String
  employeeId String

  comment  ProjectComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  employee Employee       @relation("ProjectMention", fields: [employeeId], references: [id])

  @@unique([commentId, employeeId])
  @@map("project_comment_mentions")
}

model ProjectAttachment {
  id        String  @id @default(cuid())
  projectId String?
  phaseId   String?
  taskId    String?
  commentId String?

  fileName   String
  fileUrl    String
  fileSize   Int
  mimeType   String
  uploaderId String

  project  Project?        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  phase    ProjectPhase?   @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  task     ProjectTask?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  comment  ProjectComment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  uploader Employee        @relation("ProjectAttachmentUploader", fields: [uploaderId], references: [id])

  createdAt DateTime @default(now())

  @@index([projectId])
  @@index([taskId])
  @@index([uploaderId])
  @@map("project_attachments")
}

model ProjectActivity {
  id         String @id @default(cuid())
  projectId  String
  actorId    String
  action     String
  targetType String
  targetId   String
  summary    String

  project Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  actor   Employee @relation("ProjectActivityActor", fields: [actorId], references: [id])

  createdAt DateTime @default(now())

  @@index([projectId])
  @@index([actorId])
  @@index([createdAt])
  @@map("project_activities")
}

model ProjectAuditLog {
  id         String  @id @default(cuid())
  projectId  String
  actorId    String
  action     String
  targetType String
  targetId   String
  beforeData Json?
  afterData  Json?
  ipAddress  String?
  userAgent  String?

  createdAt DateTime @default(now())

  project Project  @relation("ProjectAuditLogs", fields: [projectId], references: [id], onDelete: Cascade)
  actor   Employee @relation("EmployeeProjectAuditLogs", fields: [actorId], references: [id])

  @@index([projectId])
  @@index([actorId])
  @@index([createdAt])
  @@map("project_audit_logs")
}

// ==================== 專案範本 ====================

model ProjectTemplate {
  id          String      @id @default(cuid())
  name        String
  description String?     @db.Text
  category    String? // Template category (e.g., "軟體開發", "行銷活動", "工程建設")
  type        ProjectType @default(INTERNAL)
  companyId   String
  createdById String
  isActive    Boolean     @default(true)

  phases ProjectTemplatePhase[]
  tags   ProjectTemplateTag[]

  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy Employee @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([category])
  @@map("project_templates")
}

model ProjectTemplatePhase {
  id           String  @id @default(cuid())
  templateId   String
  name         String
  description  String? @db.Text
  sortOrder    Int
  durationDays Int? // Suggested duration in days

  tasks    ProjectTemplateTask[]
  template ProjectTemplate       @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("project_template_phases")
}

model ProjectTemplateTask {
  id             String       @id @default(cuid())
  phaseId        String
  parentId       String?
  name           String
  description    String?      @db.Text
  priority       TaskPriority @default(MEDIUM)
  estimatedHours Float?
  durationDays   Int? // Suggested duration in days
  sortOrder      Int          @default(0)

  phase    ProjectTemplatePhase  @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  parent   ProjectTemplateTask?  @relation("TemplateTaskChildren", fields: [parentId], references: [id])
  children ProjectTemplateTask[] @relation("TemplateTaskChildren")

  @@index([phaseId])
  @@map("project_template_tasks")
}

model ProjectTemplateTag {
  id         String @id @default(cuid())
  templateId String
  name       String

  template ProjectTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, name])
  @@map("project_template_tags")
}

// ==================== 專案 KPI ====================

model ProjectKpiSetting {
  id               String  @id @default(cuid())
  companyId        String  @unique
  completionWeight Float   @default(0.4) // 完成率權重
  onTimeWeight     Float   @default(0.35) // 準時率權重
  qualityWeight    Float   @default(0.25) // 品質分權重

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("project_kpi_settings")
}

model ProjectKpiSummary {
  id            String @id @default(cuid())
  companyId     String
  departmentId  String
  year          Int
  month         Int

  projectCount   Int   @default(0) // 專案數
  completedCount Int   @default(0) // 完成數
  avgCompletion  Float @default(0) // 平均完成率
  avgOnTime      Float @default(0) // 平均準時率
  avgQuality     Float @default(0) // 平均品質分
  overallScore   Float @default(0) // 綜合績效分數
  targetScore    Float? // 目標分數

  company    Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, departmentId, year, month])
  @@index([companyId])
  @@index([departmentId])
  @@index([year, month])
  @@map("project_kpi_summaries")
}

// ==================== 薪資管理 ====================

// 保險類型
enum InsuranceType {
  LABOR // 勞保
  HEALTH // 健保
  PENSION // 勞退
}

// 薪資期間狀態
enum PayrollStatus {
  DRAFT // 草稿
  CALCULATED // 已計算
  APPROVED // 已核准
  PAID // 已發放
}

// 薪資設定（公司層級）
model PayrollSetting {
  id        String  @id @default(cuid())
  companyId String  @unique
  company   Company @relation(fields: [companyId], references: [id])

  // 勞保費率 (2026/民國115年: 12.5% 含就保1%, 員工負擔 20%, 雇主 70%)
  laborInsuranceRate     Decimal @default(0.125) @db.Decimal(5, 4)
  laborInsuranceEmpShare Decimal @default(0.2) @db.Decimal(5, 4)

  // 健保費率 (2026/民國115年: 5.17%, 員工負擔 30%, 雇主 60%)
  healthInsuranceRate     Decimal @default(0.0517) @db.Decimal(5, 4)
  healthInsuranceEmpShare Decimal @default(0.3) @db.Decimal(5, 4)

  // 勞退提撥率 (雇主 6%, 員工可自提 0-6%)
  laborPensionRate Decimal @default(0.06) @db.Decimal(5, 4)

  // 加班費倍率 (依勞基法第24條)
  overtimeRate1       Decimal @default(1.34) @db.Decimal(5, 4) // 前2小時
  overtimeRate2       Decimal @default(1.67) @db.Decimal(5, 4) // 超過2小時
  overtimeRateHoliday Decimal @default(2.00) @db.Decimal(5, 4) // 休息日/假日

  // 2026年基本工資
  minimumWage Decimal @default(29500) @db.Decimal(15, 2)

  // 扣繳起扣點 (2026年)
  withholdingThreshold Decimal @default(88501) @db.Decimal(15, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payroll_settings")
}

// 投保級距表（可年度更新）
model InsuranceGrade {
  id            String        @id @default(cuid())
  year          Int // 年度 (如 2026)
  type          InsuranceType // LABOR / HEALTH / PENSION
  grade         Int // 級數
  minSalary     Decimal       @db.Decimal(15, 2) // 薪資下限
  maxSalary     Decimal?      @db.Decimal(15, 2) // 薪資上限 (最高級為 null)
  insuredAmount Decimal       @db.Decimal(15, 2) // 投保金額

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([year, type, grade])
  @@index([year, type])
  @@map("insurance_grades")
}

// 投保級距範本
model InsuranceGradeTemplate {
  id          String   @id @default(cuid())
  name        String   // 範本名稱
  description String?  // 範本說明
  baseYear    Int      // 基準年度
  createdBy   String?  // 建立者

  items       InsuranceGradeTemplateItem[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("insurance_grade_templates")
}

// 投保級距範本項目
model InsuranceGradeTemplateItem {
  id            String                  @id @default(cuid())
  templateId    String
  template      InsuranceGradeTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)

  type          InsuranceType // LABOR / HEALTH / PENSION
  grade         Int // 級數
  minSalary     Decimal       @db.Decimal(15, 2) // 薪資下限
  maxSalary     Decimal?      @db.Decimal(15, 2) // 薪資上限
  insuredAmount Decimal       @db.Decimal(15, 2) // 投保金額

  @@unique([templateId, type, grade])
  @@map("insurance_grade_template_items")
}

// 員工薪資檔案
model EmployeeSalary {
  id         String  @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id])

  baseSalary Decimal  @db.Decimal(15, 2) // 底薪
  allowances Json? // 津貼 [{name, amount}]

  // 投保級距
  laborInsuranceGrade  Decimal @db.Decimal(15, 2)
  healthInsuranceGrade Decimal @db.Decimal(15, 2)
  laborPensionGrade    Decimal @db.Decimal(15, 2)

  // 員工自提勞退 (0-6%)
  employeePensionRate Decimal @default(0) @db.Decimal(5, 4)

  // 扶養親屬數
  dependents Int @default(0)

  effectiveDate DateTime
  endDate       DateTime?
  isActive      Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, companyId, effectiveDate])
  @@index([employeeId])
  @@index([companyId])
  @@index([isActive])
  @@map("employee_salaries")
}

// 薪資期間
model PayrollPeriod {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  year   Int
  month  Int
  status PayrollStatus @default(DRAFT)

  calculatedAt DateTime?
  calculatedBy String?
  approvedAt   DateTime?
  approvedBy   String?
  paidAt       DateTime?
  paidBy       String?

  slips PayrollSlip[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, year, month])
  @@index([companyId])
  @@index([status])
  @@map("payroll_periods")
}

// 薪資單
model PayrollSlip {
  id         String  @id @default(cuid())
  periodId   String
  period     PayrollPeriod @relation(fields: [periodId], references: [id])
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])
  companyId  String

  // 應發
  baseSalary  Decimal @db.Decimal(15, 2)
  allowances  Decimal @default(0) @db.Decimal(15, 2)
  overtimePay Decimal @default(0) @db.Decimal(15, 2)
  bonus       Decimal @default(0) @db.Decimal(15, 2)
  otherIncome Decimal @default(0) @db.Decimal(15, 2)
  grossPay    Decimal @db.Decimal(15, 2)

  // 扣除
  laborInsurance  Decimal @default(0) @db.Decimal(15, 2)
  healthInsurance Decimal @default(0) @db.Decimal(15, 2)
  laborPension    Decimal @default(0) @db.Decimal(15, 2)
  incomeTax       Decimal @default(0) @db.Decimal(15, 2)
  otherDeduction  Decimal @default(0) @db.Decimal(15, 2)
  totalDeduction  Decimal @db.Decimal(15, 2)

  // 實發
  netPay Decimal @db.Decimal(15, 2)

  // 加班明細
  overtimeDetails Json?
  note            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([periodId, employeeId])
  @@index([periodId])
  @@index([employeeId])
  @@map("payroll_slips")
}

// ==================== 新版流程管理系統 ====================

// 流程模組類型
enum FlowModuleType {
  LEAVE        // 請假
  EXPENSE      // 費用核銷
  SEAL         // 用印申請
  CARD         // 名片申請
  STATIONERY   // 文具申請
  OVERTIME     // 加班申請
  BUSINESS_TRIP // 出差申請
}

// 審核人指定方式
enum FlowAssigneeType {
  DIRECT_SUPERVISOR  // 申請者的直屬主管
  POSITION           // 依職位
  SPECIFIC_PERSON    // 指定特定人員
}

// 流程範本 - 每間公司每種申請類型一個
model FlowTemplate {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])

  moduleType  FlowModuleType
  name        String            // 範本名稱
  description String?

  isActive    Boolean  @default(true)
  version     Int      @default(1)

  steps       FlowStep[]
  executions  FlowExecution[]

  createdById String
  createdBy   Employee @relation("FlowTemplateCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyId, moduleType])
  @@index([companyId, isActive])
  @@map("flow_templates")
}

// 流程步驟 - 定義每一層審核（最多4層）
model FlowStep {
  id          String   @id @default(cuid())
  templateId  String
  template    FlowTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  stepOrder   Int               // 順序：1, 2, 3, 4
  name        String            // 步驟名稱

  // 審核人指定方式（混合模式）
  assigneeType        FlowAssigneeType
  positionId          String?           // 若為 POSITION
  position            Position?         @relation(fields: [positionId], references: [id])
  specificEmployeeId  String?           // 若為 SPECIFIC_PERSON
  specificEmployee    Employee?         @relation("FlowStepSpecificApprover", fields: [specificEmployeeId], references: [id])

  isRequired  Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([templateId, stepOrder])
  @@index([templateId])
  @@map("flow_steps")
}

// 流程執行狀態
enum FlowExecutionStatus {
  PENDING     // 審核中
  APPROVED    // 全部通過
  REJECTED    // 被駁回
  CANCELLED   // 申請人取消
}

// 流程執行實例 - 每筆申請單建立一個
model FlowExecution {
  id          String   @id @default(cuid())
  templateId  String
  template    FlowTemplate @relation(fields: [templateId], references: [id])

  // 關聯到具體申請單
  moduleType  FlowModuleType
  referenceId String            // 對應的申請單 ID

  applicantId String
  applicant   Employee @relation("FlowExecutionApplicant", fields: [applicantId], references: [id])

  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])

  currentStep Int      @default(1)
  status      FlowExecutionStatus @default(PENDING)

  completedAt DateTime?

  approvals   FlowApprovalRecord[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([moduleType, referenceId])
  @@index([applicantId, status])
  @@index([companyId])
  @@map("flow_executions")
}

// 審核決定
enum FlowApprovalDecision {
  APPROVED
  REJECTED
}

// 審核紀錄 - 每一層審核的結果
model FlowApprovalRecord {
  id          String   @id @default(cuid())
  executionId String
  execution   FlowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  stepOrder   Int
  stepName    String

  // 原本應該審核的人
  assigneeId  String
  assignee    Employee @relation("FlowApprovalAssignee", fields: [assigneeId], references: [id])

  // 實際審核的人（若為代理則與 assignee 不同）
  actualApproverId  String?
  actualApprover    Employee? @relation("FlowApprovalActualApprover", fields: [actualApproverId], references: [id])

  // 若為代理審核，關聯到代理設定
  delegationId      String?
  delegation        Delegation? @relation(fields: [delegationId], references: [id])

  decision    FlowApprovalDecision?
  comment     String?
  decidedAt   DateTime?

  createdAt   DateTime @default(now())

  @@unique([executionId, stepOrder])
  @@index([executionId])
  @@index([assigneeId])
  @@map("flow_approval_records")
}

// ==================== 職務代理系統 ====================

// 代理狀態
enum DelegationStatus {
  PENDING     // 待接受
  ACCEPTED    // 已接受生效中
  REJECTED    // 已拒絕
  EXPIRED     // 已過期
  CANCELLED   // 已取消
}

// 代理權限類型
enum DelegationPermissionType {
  APPROVE_LEAVE       // 代理審核請假
  APPROVE_EXPENSE     // 代理審核費用核銷
  APPROVE_SEAL        // 代理審核用印
  APPROVE_CARD        // 代理審核名片
  APPROVE_STATIONERY  // 代理審核文具
  APPLY_LEAVE         // 代理申請請假
  APPLY_EXPENSE       // 代理申請費用核銷
  VIEW_REPORTS        // 代理查看報表
}

// 職務代理設定
model Delegation {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])

  // 委託人（被代理的人）
  delegatorId String
  delegator   Employee @relation("DelegationDelegator", fields: [delegatorId], references: [id])

  // 代理人
  delegateId  String
  delegate    Employee @relation("DelegationDelegate", fields: [delegateId], references: [id])

  // 代理權限範圍
  permissions DelegationPermission[]

  // 生效期間
  startDate   DateTime
  endDate     DateTime?   // null = 永久

  // 狀態
  status      DelegationStatus @default(PENDING)

  // 接受/拒絕
  respondedAt   DateTime?
  rejectReason  String?

  // 取消相關
  cancelledAt   DateTime?
  cancelledById String?
  cancelledBy   Employee? @relation("DelegationCanceller", fields: [cancelledById], references: [id])
  cancelReason  String?     // 至少10字

  // 建立者
  createdById String
  createdBy   Employee @relation("DelegationCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 關聯的審核紀錄（代理審核時記錄）
  approvalRecords FlowApprovalRecord[]

  @@index([delegatorId, status])
  @@index([delegateId, status])
  @@index([companyId])
  @@map("delegations")
}

// 代理權限項目
model DelegationPermission {
  id            String   @id @default(cuid())
  delegationId  String
  delegation    Delegation @relation(fields: [delegationId], references: [id], onDelete: Cascade)

  permissionType DelegationPermissionType

  @@unique([delegationId, permissionType])
  @@map("delegation_permissions")
}

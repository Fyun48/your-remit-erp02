# 即時訊息增強與權限系統設計

> 設計日期：2026-01-18
> 狀態：待實作

## 概述

本設計涵蓋以下功能模組：
1. **訊息已讀顯示** - 單勾/雙勾邏輯
2. **Header 未讀通知** - 右上角訊息提示
3. **彈出式聊天視窗** - 頁內浮動 + 獨立視窗
4. **截圖功能** - 螢幕截圖 + 對話截圖
5. **LINE 整合** - 帳號連動與分享
6. **權限系統** - 基本權限 + 特殊權限管理

---

## Part 1：訊息已讀顯示邏輯

### 顯示規則

| 狀態 | 顯示 | 說明 |
|------|------|------|
| 發送中 | 無符號 | 訊息傳送中 |
| 已送達 | ✓ 單勾 | 訊息已存入資料庫 |
| 已讀取 | ✓✓ 雙勾 | 對方的 `lastReadAt` > 訊息的 `createdAt` |

### 技術實作

- 訊息表已有 `createdAt`
- 參與者表已有 `lastReadAt`
- 前端比對兩者時間判斷顯示
- 輪詢機制：對話視窗開啟時，每 5 秒重新取得訊息狀態

---

## Part 2：Header 未讀訊息通知

### UI 設計

```
┌─────────────────────────────────────────────────┐
│  LOGO    搜尋...        💬3   🔔5   👤 王小明  │
└─────────────────────────────────────────────────┘
                          ↑     ↑
                       訊息   通知
```

### 互動行為

| 動作 | 結果 |
|------|------|
| 顯示紅點數字 | 未讀訊息總數（跨所有對話） |
| 點擊訊息圖示 | 展開下拉選單，顯示最近 5 筆未讀對話 |
| 點擊對話項目 | 跳轉到 `/dashboard/messages` 並開啟該對話 |
| 點擊「查看全部」 | 跳轉到訊息頁面 |
| 數字超過 99 | 顯示 `99+` |

### 即時更新

- 每 10 秒輪詢未讀數量
- 收到新訊息時立即更新

---

## Part 3：彈出式聊天視窗

### 模式 A：頁內浮動視窗

```
┌─ ERP 主畫面 ─────────────────────────────┐
│                                          │
│   ┌─ 聊天視窗 ──────────┐               │
│   │ 王小明        ─ □ ⧉ ✕│               │
│   │──────────────────────│               │
│   │ [對話內容...]        │               │
│   │                      │               │
│   │──────────────────────│               │
│   │ 輸入訊息...    [送出]│               │
│   └──────────────────────┘               │
│                                          │
└──────────────────────────────────────────┘
```

**功能：**
- 可拖曳到頁面任意位置
- 可調整視窗大小
- 最小化：縮成小圖示在角落
- 點擊 ⧉ 進入模式 B

### 模式 B：獨立瀏覽器視窗

- 使用 `window.open()` 開啟 `/dashboard/messages/popup/[conversationId]`
- 可拖到第二螢幕
- 關閉 ERP 主頁面，聊天視窗仍存在
- 支援多個對話同時彈出

---

## Part 4：截圖功能

### 功能 A：螢幕截圖工具

**觸發方式：**
- 聊天輸入框旁的 📷 按鈕
- 快捷鍵 `Ctrl + Shift + S`

**操作流程：**
1. 點擊截圖
2. 畫面變暗
3. 滑鼠框選區域
4. 預覽截圖
5. 選擇「取消」或「貼上對話」

**技術實作：**
- 使用 `navigator.mediaDevices.getDisplayMedia()` API
- 截圖後轉為 PNG 自動上傳

### 功能 B：對話截圖

**觸發方式：**
- 聊天視窗右上角選單 →「匯出對話截圖」

**選擇範圍：**
- 最近 10 則訊息
- 最近 50 則訊息
- 今日對話
- 自訂時間範圍

**輸出格式：**
- PNG 圖片
- 包含對話標題、時間範圍、訊息內容
- 底部顯示「由 ERP 系統產生」

---

## Part 5：LINE 分享整合

### 帳號連動流程

1. 系統設定 → LINE 帳號連動 → 點擊「連結 LINE」
2. 跳轉 LINE Login 授權頁面
3. 用戶授權 → 取得 Access Token
4. 連動完成，顯示 LINE 顯示名稱與頭像

### 資料儲存

Employee 表新增欄位：
- `lineUserId` - LINE 用戶 ID
- `lineAccessToken` - 存取令牌
- `lineTokenExpiresAt` - 令牌到期時間

### 分享操作

1. 長按/右鍵訊息 →「分享到 LINE」
2. 開啟 LINE 分享介面（LINE Share API）
3. 用戶選擇對象
4. 送出

**可分享內容：**
- 文字訊息
- 圖片
- 檔案（以連結形式）
- 對話截圖

---

## Part 6：權限系統

### 權限層級架構

```
最終權限 = 基本權限 + 部門/職位權限 + 特殊權限（最高優先級）
```

### 基本權限（所有員工）

| 功能模組 | 權限 |
|----------|------|
| 儀表板 | ✅ 完整 |
| 出勤管理 | ✅ 打卡、查看自己 |
| 內部訊息 | ✅ 完整 |
| 請假管理 | ✅ 申請、查看自己 |
| 費用報銷 | ✅ 申請、查看自己 |
| 審核中心 | ✅ 查看自己進度 |
| 行政申請 | ✅ 用印/名片/文具 |
| 組織圖 | 👁️ 唯讀 |
| 人事管理 | ❌ 只能看自己 |
| 流程管理 | ❌ 隱藏 |
| 財務會計 | ❌ 隱藏 |
| 報表中心 | ❌ 隱藏 |
| 系統管理 | ❌ 隱藏 |

### 部門/職位加成規則

| 條件 | 額外權限 |
|------|----------|
| 部門 = 財務會計部（職位非總務） | +財務會計 |
| 職位 = 總務（一般） | +人事管理（同公司） |
| 職位 = 總務（主管級，Level ≥ 5） | +人事管理（跨公司） |

### 特殊權限資料結構

```typescript
{
  employeeId: string,
  module: string,        // 模組代碼
  subModules: string[],  // 子功能
  actions: {
    view: boolean,
    create: boolean,
    update: boolean,
    delete: boolean,
  },
  scope: 'all' | 'same_company' | 'same_department' | 'specific',
  specificIds: string[],
  expiresAt: Date | null,
  reason: string,
  grantedBy: string,
  grantedAt: Date,
}
```

### 特殊權限管理功能

1. **權限範本** - 預設權限包快速套用
2. **批次授權** - 多人同時授予相同權限
3. **權限繼承** - 可選擇繼承主管權限
4. **到期提醒** - 7天/3天前通知
5. **操作日誌** - 完整權限變更紀錄

---

## 實作順序

### Phase 1 - 核心修復（優先）
1. 訊息已讀顯示邏輯
2. Header 未讀訊息通知
3. 基本權限系統重構

### Phase 2 - 訊息增強
4. 頁內浮動聊天視窗
5. 獨立瀏覽器視窗
6. 螢幕截圖工具
7. 對話截圖匯出

### Phase 3 - 權限強化
8. 特殊權限管理介面
9. 權限範本與批次授權

### Phase 4 - LINE 整合
10. LINE 帳號連動
11. LINE 分享功能

### Phase 5 - 進階功能（未來）
12. 權限審核流程

---

## 預估影響檔案

| 類別 | 新增 | 修改 |
|------|------|------|
| Prisma Schema | 1 | 1 |
| API Router | 2 | 3 |
| 頁面元件 | 6 | 4 |
| 共用元件 | 5 | 2 |
| 工具函數 | 3 | 1 |
| **總計** | **17** | **11** |
